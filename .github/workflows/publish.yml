name: Upload Crates.io Package

on:
  push:
    tags:
      - v*.*.*

permissions:
  contents: read

jobs:
  test:
    name: Test
    strategy:
      matrix:
        os: [ ubuntu-latest, macOS-latest, "windows-latest" ]
        rust:
          - stable
        args:
          - '--no-default-features'

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v1
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          override: true
      - name: cargo fetch
        uses: actions-rs/cargo@v1
        with:
          command: fetch
      - name: cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --tests ${{ matrix.args }}
      - name: cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: ${{ matrix.args }}

  cargo-deny:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: EmbarkStudios/cargo-deny-action@v2

  publish_check:
    name: Publish check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: cargo fetch
        uses: actions-rs/cargo@v1
        with:
          command: fetch
      - name: cargo publish
        uses: actions-rs/cargo@v1
        with:
          command: publish
          args: --dry-run --no-default-features
      - name: docs check
        uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --no-deps --no-default-features

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [ test, cargo-deny, publish_check ]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v1
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
      - name: cargo fetch
        uses: actions-rs/cargo@v1
        with:
          command: fetch
      - name: cargo publish
        uses: actions-rs/cargo@v1
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        with:
          command: publish
          args: --no-default-features

  build_artifacts:
    name: Build artifacts
    needs: [ test, cargo-deny, publish_check ]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      actions: write
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            args: "--no-default-features"
            archive_ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            args: "--no-default-features"
            archive_ext: zip
          - os: macOS-latest
            target: aarch64-apple-darwin
            args: "--no-default-features"
            archive_ext: tar.gz

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v1
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.target }}
          override: true
      - name: cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --target ${{ matrix.target }} ${{ matrix.args }}
      - name: Package (unix)
        if: runner.os != 'Windows'
        run: |
          set -euo pipefail
          bin="one2html"
          archive="one2html-${{ matrix.target }}.${{ matrix.archive_ext }}"
          mkdir -p dist
          cp "target/${{ matrix.target }}/release/${bin}" "dist/${bin}"
          tar -C dist -czf "${archive}" "${bin}"
          shasum -a 256 "${archive}" > "${archive}.sha256"
      - name: Package (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $bin = "one2html.exe"
          $archive = "one2html-${{ matrix.target }}.${{ matrix.archive_ext }}"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/$bin" "dist/$bin"
          Compress-Archive -Path "dist/$bin" -DestinationPath $archive
          $hash = (Get-FileHash -Algorithm SHA256 $archive).Hash.ToLower()
          "$hash  $archive" | Out-File -FilePath "$archive.sha256" -Encoding ascii
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: one2html-${{ matrix.target }}
          path: |
            one2html-${{ matrix.target }}.${{ matrix.archive_ext }}
            one2html-${{ matrix.target }}.${{ matrix.archive_ext }}.sha256

  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: [ publish, build_artifacts ]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
      actions: read
    steps:
      - name: Extract release notes
        run: |
          set -euo pipefail
          tag="${{ github.ref_name }}"
          python3 - <<'PY'
          import re
          import sys

          tag = "${{ github.ref_name }}"
          found = False
          lines = []
          with open("CHANGELOG.md", "r", encoding="utf-8") as fh:
              for raw in fh:
                  line = raw.rstrip("\n")
                  if line.startswith("## ["):
                      if found:
                          break
                      if line.startswith(f"## [{tag}"):
                          found = True
                          continue
                  if found:
                      lines.append(line)

          if not lines:
              print(f"No changelog entry found for {tag}.", file=sys.stderr)
              sys.exit(1)

          out = []
          prev = ""
          for line in lines:
              if not line.strip():
                  out.append("")
                  prev = ""
                  continue
              is_heading = line.startswith("#")
              is_list = re.match(r"^(\s*[-*]|\s*\d+\.)\s+", line) is not None
              is_cont = prev and prev.lstrip().startswith(("-", "*")) and line.startswith("  ")
              if prev and not is_heading and not is_list and not is_cont:
                  out[-1] = out[-1].rstrip() + " " + line.strip()
              else:
                  out.append(line)
              prev = line

          with open("release-notes.md", "w", encoding="utf-8") as fh:
              fh.write("\n".join(out).rstrip() + "\n")
          PY
      - uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body_path: release-notes.md
          files: release-assets/*
          draft: false
          prerelease: false
